From 5fb3493773b5c2f8b03f55ddf79520bb66cdbc45 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Fr=C3=A9d=C3=A9ric=20Pierret=20=28fepitre=29?=
 <frederic.pierret@qubes-os.org>
Date: Sun, 8 Nov 2020 16:17:29 +0100
Subject: [PATCH] Strip build path directories in tools, xen and xen/arch/x86

Ensure to have a realpath for XEN_ROOT else it fails to substitute
properly pathes in strings sections
---
 xen/arch/x86/Makefile | 1 +
 3 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/xen/arch/x86/Makefile b/xen/arch/x86/Makefile
index b388861679..cbed7d9a16 100644
--- a/xen/arch/x86/Makefile
+++ b/xen/arch/x86/Makefile
@@ -126,6 +126,7 @@ export XEN_BUILD_EFI := $(shell $(CC) $(
 EFI_LDFLAGS = $(patsubst -m%,-mi386pep,$(XEN_LDFLAGS)) --subsystem=10 --strip-debug
 XEN_BUILD_PE := $(if $(XEN_BUILD_EFI),$(shell $(LD) $(EFI_LDFLAGS) -o efi/check.efi efi/check.o 2>/dev/null && echo y))
 CFLAGS-$(XEN_BUILD_EFI) += -DXEN_BUILD_EFI
+CFLAGS-$(XEN_BUILD_EFI) += -ffile-prefix-map=$(XEN_ROOT)=.
 # Check if the linker produces fixups in PE by default (we need to disable it doing so for now).
 XEN_NO_PE_FIXUPS := $(if $(XEN_BUILD_EFI), \
                          $(shell $(LD) $(EFI_LDFLAGS) --disable-reloc-section -o efi/check.efi efi/check.o 2>/dev/null && \
                                echo --disable-reloc-section))
-- 
2.26.2

